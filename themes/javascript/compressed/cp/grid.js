!function(t){var i=window.Grid={_eventHandlers:[],bind:function(t,i,e){void 0==this._eventHandlers[i]&&(this._eventHandlers[i]=[]),this._eventHandlers[i][t]=e}};i.Publish=function(i,e){this.root=t(i),this.blankRow=this.root.find("tr.blank_row"),this.emptyField=this.root.find("tr.empty_field"),this.rowContainer=this.root.find(".grid_row_container"),this.settings=void 0!==e?e:EE.grid_field_settings[i.id],this.init(),this.eventHandlers=[]},i.Publish.prototype={init:function(){this._bindSortable(),this._bindAddButton(),this._bindDeleteButton(),this._toggleRowManipulationButtons(),this._fieldDisplay(),this.original_row_count=this._getRows().size(),this.blankRow.find(":input").attr("disabled","disabled")},_bindSortable:function(){var i=this;this.rowContainer.sortable({axis:"y",containment:"parent",handle:"td.grid_handle",cancel:"td.grid_sort_cancel",items:"tr.grid_row",sort:EE.sortable_sort_helper,helper:function(i,e){var n=e.children(),o=e.clone();return o.children().each(function(i){t(this).width(n.eq(i).width())}),o},start:function(t,e){i._fireEvent("beforeSort",e.item)},stop:function(t,e){i._fireEvent("afterSort",e.item)}})},_addMinimumRows:function(){var t=this._getRows().size(),i=this.settings.grid_min_rows-t;for(0==t&&0==i&&this.emptyField.show();i>0;)this._addRow(),i--},_toggleRowManipulationButtons:function(){var t=this._getRows().size();if(""!==this.settings.grid_max_rows){var i=this.root.find(".grid_button_add");i.toggle(t<this.settings.grid_max_rows)}if(""!==this.settings.grid_min_rows){var e=this.root.find(".grid_button_delete");e.toggle(t>this.settings.grid_min_rows)}this.rowContainer.find("td.grid_handle").toggleClass("grid_sort_cancel",1==t)},_getRows:function(){return this.rowContainer.find("tr.grid_row").not(this.blankRow.add(this.emptyField))},_bindAddButton:function(){var t=this;this.root.find(".grid_button_add, .grid_link_add").on("click",function(i){i.preventDefault(),t._addRow()})},_addRow:function(){el=this.blankRow.clone(),el.removeClass("blank_row"),this.original_row_count++,el.html(el.html().replace(RegExp("new_row_[0-9]{1,}","g"),"new_row_"+this.original_row_count)),el.find(":input").removeAttr("disabled"),this.rowContainer.append(el),this.emptyField.hide(),this._toggleRowManipulationButtons(),this._fireEvent("display",el)},_bindDeleteButton:function(){var i=this;this.root.on("click",".grid_button_delete",function(e){e.preventDefault(),row=t(this).parents("tr.grid_row"),i._fireEvent("remove",row),row.remove(),i._toggleRowManipulationButtons(),0==i._getRows().size()&&i.emptyField.show()})},_fieldDisplay:function(){var i=this;setTimeout(function(){i._getRows().each(function(){i._fireEvent("display",t(this))}),i._addMinimumRows()},500)},_fireEvent:function(e,n){if(void 0!==i._eventHandlers[e])for(var o in i._eventHandlers[e])n.find('td[data-fieldtype="'+o+'"]').each(function(){i._eventHandlers[e][o](t(this))})}},i.Settings=function(i){this.root=t("#grid_settings"),this.settingsScroller=this.root.find("#grid_col_settings_container"),this.settingsContainer=this.root.find("#grid_col_settings_container_inner"),this.colTemplateContainer=t("#grid_col_settings_elements"),this.blankColumn=this.colTemplateContainer.find(".grid_col_settings"),this.settings=i,this.init()},i.Settings.prototype={init:function(){this._bindResize(),this._bindSortable(),this._bindAddButton(),this._bindCopyButton(),this._bindDeleteButton(),this._bindDeleteButton(),this._toggleDeleteButtons(),this._bindColTypeChange(),this._bindSubmit(),this._highlightErrors(),this._bindAutoColName(this.root.find('div.grid_col_settings[data-field-name^="new_"]')),this._settingsDisplay(),this.colTemplateContainer.find(":input").attr("disabled","disabled")},_bindResize:function(){var i=this;t(document).ready(function(){i._resizeSettingsContainer(),t(window).resize(function(){i._resizeSettingsContainer()}),t("#field_type").change(function(){"grid"==t(this).val()&&i._resizeSettingsContainer()}),i._resizeColContainer()})},_resizeSettingsContainer:function(){this.settingsScroller.width(500),this.settingsScroller.width(this.root.width()-this.root.find("#grid_col_settings_labels").width())},_resizeColContainer:function(t){this.settingsContainer.animate({width:this._getColumnsWidth()},1==t?400:0)},_getColumnsWidth:function(){var t=this.root.find(".grid_col_settings");return t.size()*t.width()+75},_bindSortable:function(){this.settingsContainer.sortable({axis:"x",containment:"parent",handle:"div.grid_data_type",items:".grid_col_settings",sort:EE.sortable_sort_helper})},_bindAddButton:function(){var t=this;this.root.find(".grid_button_add").on("click",function(i){i.preventDefault(),t._insertColumn(t._buildNewColumn())})},_bindCopyButton:function(){var i=this;this.root.on("click","a.grid_col_copy",function(e){e.preventDefault();var n=t(this).parents(".grid_col_settings");i._insertColumn(i._buildNewColumn(n),n)})},_bindDeleteButton:function(){var i=this;this.root.on("click",".grid_button_delete",function(e){e.preventDefault();var n=t(this).parents(".grid_col_settings");n.index()==t("#grid_settings .grid_col_settings:last").index()?(n.remove(),i._resizeColContainer(!0),i._toggleDeleteButtons()):n.animate({opacity:0},200,function(){n.html(""),n.animate({width:0},200,function(){n.remove(),i._resizeColContainer(!0),i._toggleDeleteButtons()})})})},_toggleDeleteButtons:function(){var t=this.root.find(".grid_col_settings").size(),i=this.root.find(".grid_button_delete");i.toggle(t>1)},_insertColumn:function(i,e){var n=t("#grid_settings .grid_col_settings:last");void 0==e&&(e=n),e.index()!=n.index()&&i.css({opacity:0}),i.insertAfter(e),this._resizeColContainer(),this._toggleDeleteButtons(),e.index()==n.index()&&this.settingsScroller.animate({scrollLeft:this._getColumnsWidth()},700),i.animate({opacity:1},400),this._bindAutoColName(i),this._fireEvent("displaySettings",t(".grid_col_settings_custom > div",i))},_bindAutoColName:function(i){i.each(function(i,e){t("input.grid_col_field_label",e).bind("keyup keydown",function(){t(this).ee_url_title(t(e).find("input.grid_col_field_name"),!0)})})},_buildNewColumn:function(i){i=void 0==i?this.blankColumn.clone():this._cloneWithFormValues(i),i.find('input[name$="\\[name\\]"]').attr("value","");var e="new_"+t(".grid_col_settings",this.root).size();return i.html(i.html().replace(RegExp("(new_|col_id_)[0-9]{1,}","g"),e)),i.attr("data-field-name",e),i.find(":input").removeAttr("disabled").removeClass("grid_settings_error"),i},_bindColTypeChange:function(){var i=this;this.root.on("change",".grid_data_type .grid_col_select",function(){var e=i.colTemplateContainer.find(".grid_col_settings_custom_field_"+t(this).val()+":last").clone();e.find(":input").removeAttr("disabled");var n=t(this).parents(".grid_col_settings").find(".grid_col_settings_custom");e.html(e.html().replace(RegExp("(new_|col_id_)[0-9]{1,}","g"),n.data("fieldName"))),n.html(e),i._fireEvent("displaySettings",e)})},_bindSubmit:function(){var i=this;this.root.parents("form").submit(function(){t(".grid_col_settings_section input[type=text]").removeClass("grid_settings_error"),grid_html=i._cloneWithFormValues(i.root.parent("#grid_settings_container")),t("<input/>",{type:"hidden",name:"grid_html",value:'<div id="grid_settings_container">'+grid_html.html()+"</div>"}).appendTo(i.root)})},_cloneWithFormValues:function(i){var e=i.clone();return i.find(":input:enabled").each(function(){var i=e.find(":input[name='"+t(this).attr("name")+"']:enabled");t(this).is("select")?i.find("option").removeAttr("selected").filter('[value="'+t(this).val()+'"]').attr("selected","selected"):"checkbox"==t(this).attr("type")?i.attr("checked",t(this).attr("checked")):"radio"==t(this).attr("type")?i.removeAttr("selected").filter("[value='"+t(this).val()+"']").attr("checked",t(this).attr("checked")):t(this).is("textarea")?i.html(t(this).val()):i.attr("value",t(this).val())}),e},_settingsDisplay:function(){var i=this;this.root.find(".grid_col_settings").each(function(){i._fireEvent("displaySettings",t(".grid_col_settings_custom > div",this))})},_fireEvent:function(e,n){var o=n.data("fieldtype");void 0!==i._eventHandlers[e]&&void 0!=i._eventHandlers[e][o]&&i._eventHandlers[e][o](t(n))},_highlightErrors:function(){void 0!=this.settings.error_fields&&t.each(this.settings.error_fields,function(i,e){t('input[name="'+e+'"]').addClass("grid_settings_error")})}},EE.grid=function(t,e){return new i.Publish(t,e)},EE.grid_settings=function(t){return new i.Settings(t)},"undefined"!=typeof _&&"undefined"!==EE.grid_cache&&_.each(EE.grid_cache,function(t){i.bind.apply(i,t)})}(jQuery);